---
title: "Using geodiversity to improve SDMs for data poor species"
author: "Beth Gerstner"
date: "2023-01-02"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

Project: Using geodiversity to improve SDMs for data poor species

Description: This code calculates geodiversity metrics. It calculates sq of CHELSA biodiversity variables at multiple radii (3, 9, 15, 21, 27, 33 km). It calculcates the sq of elevation over the same radii. 

Authors: Beth E. Gerstner

Inputs: Uses SRTM elevation data, annual cloud cover, and 4 preselected CHELSA Bioclim variables to generation geodiversity measures at various radii. 

Outputs: raster files for each variable with values calculated over 6 different radii.

Date: 1/21/22

```{r, warning=FALSE, message = FALSE}
library(geodiv)
library(raster)
library(rnaturalearth)
library(dplyr)
library(rgeos)
library(maps)
library(sf)
library(rgdal)
```

Process and prepare SRTM elevation data

```{r, message=FALSE}
srtm <- raster("D:/zarnetske_lab/elevation/srtm_1km.tif")

# Pull in world map
worldMap <- ne_countries(scale = "medium", type = "countries", returnclass = "sf")

# Subset world map to region of interest for future cropping. 

SA_study_region <- worldMap %>% filter(region_wb == "Latin America & Caribbean")

# Crop the study region to the bounding box of interest
study_region_crop <-st_crop(SA_study_region, xmin = -120, xmax = -30, ymin = -30, ymax = 40)

plot(study_region_crop)


# Crop SRTM raster to that of the study region
srtm_sr <- crop(srtm, study_region_crop)
```
setwd("D:/zarnetske_lab/CHELSA_4_only")
writeRaster(srtm_sr, filename="srtm_crop", format="GTiff")


## SRTM

Calculate sq of SRTM at all radii mentioned above.
```{r, eval=FALSE}

setwd("/mnt/ufs18/rs-008/plz-lab/DATA/neotropical_frugivores/andes_geodiv/recalculate_env/srtm_geodiv/")


radii <- c(3,9,15,21,27,33)
for (i in radii) {
window <- matrix(1, nrow = i, ncol = i)
sq.srtm <- focal_metrics(srtm_sr, window, metrics = list('sq'),
                    progress = TRUE)
f.name <- paste0('srtm_sq_', i, '.tif')
  writeRaster(sq.srtm$sq, filename=f.name, format="GTiff", overwrite=T)
}


# window <- matrix(1, nrow = 3, ncol = 3)
# sq.3 <- focal_metrics(srtm_sr, window, metrics = list('sq'),
#                     progress = TRUE)
# # 
# #setwd("D:/zarnetske_lab/chelsa_sd/3x")
# # writeRaster(sq$sq, filename="sd_3km", format="GTiff")
# 
# #set to a 9km window, which is appropriate given the home range of the species being tested (this may change in future iterations)
# window <- matrix(1, nrow = 9, ncol = 9)
# sq.9 <- focal_metrics(srtm_sr, window, metrics = list('sq'),
#                     progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/9x")
# #writeRaster(sq.9$sq, filename="sd_9km", format="GTiff")
# 
# # set to a 15 km window
#  window <- matrix(1, nrow = 15, ncol = 15)
#  sq.15 <- focal_metrics(srtm_sr, window, metrics = list('sq'),
#                     progress = TRUE)
# 
# # setwd("D:/zarnetske_lab/chelsa_sd/15x")
# # writeRaster(sq.15$sq, filename="sd_15km", format="GTiff")
# 
# 
# #set to a 21 km window
# window <- matrix(1, nrow = 21, ncol = 21)
# sq.21 <- focal_metrics(srtm_sr, window, metrics = list('sq'),
#                        progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/21x")
# #writeRaster(sq.21$sq, filename="sd_21km", format="GTiff")
# 
# 
# #set to a 27 km window, which is appropriate given the home range of the species being tested (this may change in future iterations)
# window <- matrix(1, nrow = 27, ncol = 27)
# sq.27 <- focal_metrics(srtm_sr, window, metrics = list('sq'),
#                        progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/27x")
# #writeRaster(sq.27$sq, filename="sd_27km", format="GTiff")
# 
# #set to a 33 km window, which is appropriate given the home range of the species being tested (this may change in future iterations)
# window <- matrix(1, nrow = 33 , ncol = 33)
# sq.33 <- focal_metrics(srtm_sr, window, metrics = list('sq'),
#                     progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/33x")
# #writeRaster(sq.33$sq, filename="sd_33km", format="GTiff")

```

## Cloud Cover

Read in mean annual cloud cover raster from Jetz 2016 (generated from MODIS) and process raster

```{r, eval=FALSE}
cloud <- raster("C:/Users/bgers/Desktop/MSU/Zarnetske_Lab/Data/Cloud_forest_prediction_Jetz_2016/MODCF_meanannual.tiff")


# Crop cloud raster to that of the study region
cloud_sr <- crop(cloud, study_region_crop)
#setwd("C:/Users/bgers/Desktop")
#writeRaster(cloud_sr, filename="cloud_crop", format="GTiff")

```

Set to a 3km window same as above

```{r, eval=FALSE}
cloud_sr <- raster("/mnt/ufs18/rs-008/plz-lab/DATA/neotropical_frugivores/andes_geodiv/recalculate_env/base_variables/cloud_sr.tif")
radii <- c(3,9,15,21,27,33)
for (i in radii) {
window <- matrix(1, nrow = i, ncol = i)
cloud_sq <- focal_metrics(cloud_sr, window, metrics = list('sq'),
                    progress = TRUE)
f.name <- paste0('cloud_sq_', i, '.tif')
  writeRaster(cloud_sq$sq, filename=f.name, format="GTiff", overwrite=T)
}


# 
# 
# 
# 
# 
# 
# window <- matrix(1, nrow = 3, ncol = 3)
# cloud.3 <- focal_metrics(cloud_sr, window, metrics = list('sq'),
#                     progress = TRUE)
#  
# setwd("D:/zarnetske_lab/chelsa_sd/3x")
# writeRaster(cloud.3$sq, filename="cloud_3km", format="GTiff")
# 
# #set to a 9km window
# window <- matrix(1, nrow = 9, ncol = 9)
# cloud.9 <- focal_metrics(cloud_sr, window, metrics = list('sq'),
#                       progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/9x")
# #writeRaster(cloud.9$sq, filename="cloud_9km", format="GTiff")
# 
# #set to a 15 km window
# window <- matrix(1, nrow = 15, ncol = 15)
# cloud.15 <- focal_metrics(cloud_sr, window, metrics = list('sq'),
#                      progress = TRUE)
#  
# #setwd("D:/zarnetske_lab/chelsa_sd/15x")
# #writeRaster(cloud.15$sq, filename="cloud_15km", format="GTiff")
# 
# 
# #set to a 21 km window
# window <- matrix(1, nrow = 21, ncol = 21)
# cloud.21 <- focal_metrics(cloud_sr, window, metrics = list('sq'),
#                        progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/21x")
# #writeRaster(cloud.21$sq, filename="cloud_21km", format="GTiff")
# 
# 
# #set to a 27 km window
# window <- matrix(1, nrow = 27, ncol = 27)
# cloud.27 <- focal_metrics(cloud_sr, window, metrics = list('sq'),
#                        progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/27x")
# #writeRaster(cloud.27$sq, filename="cloud_27km", format="GTiff")
# 
# #set to a 33 km window, which is appropriate given the home range of the species being tested (this may change in future iterations)
# window <- matrix(1, nrow = 33 , ncol = 33)
# cloud.33 <- focal_metrics(cloud_sr, window, metrics = list('sq'),
#                        progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/33x")
# #writeRaster(cloud.33$sq, filename="cloud_33km", format="GTiff")

```

## BioClim  variables

Process environmental variables to only be for the study region
Set working directory to folder where environmental data is stored 
```{r, message=FALSE, eval=FALSE}
setwd("D:/zarnetske_lab/CHELSA_full")


# Making stack of all 19 bioclimatic variables
env <- list.files(pattern='tif', full.names=TRUE)
env <- stack(env)

# Crop extent to a smaller region so it is easier to work with
# Crop environmental variables by the larger extent

env.clip <- crop(env, study_region_crop)

#write cropped CHELSA data to file
setwd("D:/zarnetske_lab/CHELSA_full/CHELSA_crop")
for (i in 1:19) {
  writeRaster(env.clip[[i]], paste0(strsplit(names(env.clip[[i]]),"CHELSA_1")[[1]][1],'.tif'))
}

#sq of CHELSA at 3 resolutions 3, 9, 15, 21, 27, 33
# variables
#Bio5: Max Temperature of Warmest Month
#Bio6: Min Temperature of Coldest Month
#Bio13: Precipitation of Wettest Month 
#Bio14: Precipitation of Driest Month 

```

Generating the CHELSA geodiversity rasters
```{r, eval=FALSE}
#Bio5
bio5_sr <- raster("/mnt/ufs18/rs-008/plz-lab/DATA/neotropical_frugivores/andes_geodiv/recalculate_env/base_variables/bio5_1981.2010_V.2.1.tif")
radii <- c(3,9,15,21,27,33)
for (i in radii) {
window <- matrix(1, nrow = i, ncol = i)
bio5_sq <- focal_metrics(bio5_sr, window, metrics = list('sq'),
                    progress = TRUE)
f.name <- paste0('bio5_sq_', i, '.tif')
  writeRaster(bio5_sq$sq, filename=f.name, format="GTiff", overwrite=T)
}


#bio6
bio6_sr <- raster("/mnt/ufs18/rs-008/plz-lab/DATA/neotropical_frugivores/andes_geodiv/recalculate_env/base_variables/bio6_1981.2010_V.2.1.tif")
radii <- c(3,9,15,21,27,33)
for (i in radii) {
window <- matrix(1, nrow = i, ncol = i)
bio6_sq <- focal_metrics(bio6_sr, window, metrics = list('sq'),
                    progress = TRUE)
f.name <- paste0('bio6_sq_', i, '.tif')
  writeRaster(bio6_sq$sq, filename=f.name, format="GTiff", overwrite=T)
}

#bio13
bio13_sr <- raster("/mnt/ufs18/rs-008/plz-lab/DATA/neotropical_frugivores/andes_geodiv/recalculate_env/base_variables/bio13_1981.2010_V.2.1.tif")
radii <- c(3,9,15,21,27,33)
for (i in radii) {
window <- matrix(1, nrow = i, ncol = i)
bio13_sq <- focal_metrics(bio13_sr, window, metrics = list('sq'),
                    progress = TRUE)
f.name <- paste0('bio13_sq_', i, '.tif')
  writeRaster(bio13_sq$sq, filename=f.name, format="GTiff", overwrite=T)
}

#bio14
bio14_sr <- raster("/mnt/ufs18/rs-008/plz-lab/DATA/neotropical_frugivores/andes_geodiv/recalculate_env/base_variables/bio14_1981.2010_V.2.1.tif")
radii <- c(3,9,15,21,27,33)
for (i in radii) {
window <- matrix(1, nrow = i, ncol = i)
bio14_sq <- focal_metrics(bio14_sr, window, metrics = list('sq'),
                    progress = TRUE)
f.name <- paste0('bio14_sq_', i, '.tif')
  writeRaster(bio14_sq$sq, filename=f.name, format="GTiff", overwrite=T)
}



# #Pull bio5 out of stack
# bio5 <- env.clip[[15]]
# 
# # #sq of bio5 3km
# window <- matrix(1, nrow = 3 , ncol = 3)
# bio5_sd_3km <- focal_metrics(bio5, window, metrics = list('sq'),
#                     progress = TRUE)
# 
# # setwd("D:/zarnetske_lab/chelsa_sd/3x")
# # writeRaster(bio5_sd_3km$sq, filename="bio5_sd_3km", format="GTiff")
# 
# #sq of bio5 9km
# window <- matrix(1, nrow = 9 , ncol = 9)
# bio5_sd_9km <- focal_metrics(bio5, window, metrics = list('sq'),
#                              progress = TRUE)
# 
# # setwd("D:/zarnetske_lab/chelsa_sd/9x")
# # writeRaster(bio5_sd_9km$sq, filename="bio5_sd_9km", format="GTiff")
# 
# #sq of bio5 15km
# window <- matrix(1, nrow = 15 , ncol = 15)
# bio5_sd_15km <- focal_metrics(bio5, window, metrics = list('sq'),
#                               progress = TRUE)
# # 
# # setwd("D:/zarnetske_lab/chelsa_sd/15x")
# # writeRaster(bio5_sd_15km$sq, filename="bio5_sd_15km", format="GTiff")
# 
# #sq of bio5 21km
# window <- matrix(1, nrow = 21 , ncol = 21)
# bio5_sd_21km <- focal_metrics(bio5, window, metrics = list('sq'),
#                               progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/21x")
# #writeRaster(bio5_sd_21km$sq, filename="bio5_sd_21km", format="GTiff")
# 
# #sq of bio5 27km
# window <- matrix(1, nrow = 27 , ncol = 27)
# bio5_sd_27km <- focal_metrics(bio5, window, metrics = list('sq'),
#                              progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/27x")
# #writeRaster(bio5_sd_27km$sq, filename="bio5_sd_27km", format="GTiff")
# 
# #sq of bio5 33km
# window <- matrix(1, nrow = 33 , ncol = 33)
# bio5_sd_33km <- focal_metrics(bio5, window, metrics = list('sq'),
#                              progress = TRUE)
# 
# #setwd("D:/zarnetske_lab/chelsa_sd/33x")
# #writeRaster(bio5_sd_33km$sq, filename="bio5_sd_33km", format="GTiff")
#______

#Pull bio6 out of stack
bio6 <- env.clip[[16]]

# sq of bio6 3km
window <- matrix(1, nrow = 3 , ncol = 3)
bio6_sd_3km <- focal_metrics(bio6, window, metrics = list('sq'),
                            progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/3x")
#writeRaster(bio6_sd_3km$sq, filename="bio6_sd_3km", format="GTiff")

#sq of bio6 9km
window <- matrix(1, nrow = 9 , ncol = 9)
bio6_sd_9km <- focal_metrics(bio6, window, metrics = list('sq'),
                             progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/9x")
#writeRaster(bio6_sd_9km$sq, filename="bio6_sd_9km", format="GTiff")

# sq of bio6 15km
window <- matrix(1, nrow = 15 , ncol = 15)
bio6_sd_15km <- focal_metrics(bio6, window, metrics = list('sq'),
                             progress = TRUE)
# 
# setwd("D:/zarnetske_lab/chelsa_sd/15x")
# writeRaster(bio6_sd_15km$sq, filename="bio6_sd_15km", format="GTiff")

#sq of bio6 21km
window <- matrix(1, nrow = 21 , ncol = 21)
bio6_sd_21km <- focal_metrics(bio6, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/21x")
#writeRaster(bio6_sd_21km$sq, filename="bio6_sd_21km", format="GTiff")

#sq of bio6 27km
window <- matrix(1, nrow = 27 , ncol = 27)
bio6_sd_27km <- focal_metrics(bio6, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/27x")
#writeRaster(bio6_sd_27km$sq, filename="bio6_sd_27km", format="GTiff")

#sq of bio6 33km
window <- matrix(1, nrow = 33 , ncol = 33)
bio6_sd_33km <- focal_metrics(bio6, window, metrics = list('sq'),
                             progress = TRUE)

setwd("D:/zarnetske_lab/chelsa_sd/33x")
writeRaster(bio6_sd_33km$sq, filename="bio6_sd_33km", format="GTiff")

#______

#Pull bio13 out of stack
bio13 <- env.clip[[5]]


# #sq of bio13 3km
window <- matrix(1, nrow = 3 , ncol = 3)
bio13_sd_3km <- focal_metrics(bio13, window, metrics = list('sq'),
                             progress = TRUE)
# 
# setwd("D:/zarnetske_lab/chelsa_sd/3x")
# writeRaster(bio13_sd_3km$sq, filename="bio13_sd_3km", format="GTiff")

#sq of bio13 9km
window <- matrix(1, nrow = 9 , ncol = 9)
bio13_sd_9km <- focal_metrics(bio13, window, metrics = list('sq'),
                              progress = TRUE)

setwd("D:/zarnetske_lab/chelsa_sd/9x")
writeRaster(bio13_sd_9km$sq, filename="bio13_sd_9km", format="GTiff")


# #sq of bio13 15km
window <- matrix(1, nrow = 15 , ncol = 15)
bio13_sd_15km <- focal_metrics(bio13, window, metrics = list('sq'),
                             progress = TRUE)
# 
# setwd("D:/zarnetske_lab/chelsa_sd/15x")
# writeRaster(bio13_sd_15km$sq, filename="bio13_sd_15km", format="GTiff")

#sq of bio13 21km
window <- matrix(1, nrow = 21 , ncol = 21)
bio13_sd_21km <- focal_metrics(bio13, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/21x")
#writeRaster(bio13_sd_21km$sq, filename="bio13_sd_21km", format="GTiff")

#sq of bio13 27km
window <- matrix(1, nrow = 27 , ncol = 27)
bio13_sd_27km <- focal_metrics(bio13, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/27x")
#writeRaster(bio13_sd_27km$sq, filename="bio13_sd_27km", format="GTiff")

#sq of bio13 33km
window <- matrix(1, nrow = 33 , ncol = 33)
bio13_sd_33km <- focal_metrics(bio13, window, metrics = list('sq'),
                             progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/33x")
#writeRaster(bio13_sd_33km$sq, filename="bio13_sd_33km", format="GTiff")

#______

#Pull bio14 out of stack
bio14 <- env.clip[[6]]

# #sq of bio13 3km
window <- matrix(1, nrow = 3 , ncol = 3)
bio14_sd_3km <- focal_metrics(bio14, window, metrics = list('sq'),
                               progress = TRUE)
# 
# setwd("D:/zarnetske_lab/chelsa_sd/3x")
# writeRaster(bio14_sd_3km$sq, filename="bio14_sd_3km", format="GTiff")

#sq of bio13 9km
window <- matrix(1, nrow = 9 , ncol = 9)
bio14_sd_9km <- focal_metrics(bio14, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/9x")
#writeRaster(bio14_sd_9km$sq, filename="bio14_sd_9km", format="GTiff")

# #sq of bio14 15km
window <- matrix(1, nrow = 15 , ncol = 15)
bio14_sd_15km <- focal_metrics(bio14, window, metrics = list('sq'),
                               progress = TRUE)
# 
# setwd("D:/zarnetske_lab/chelsa_sd/15x")
# writeRaster(bio14_sd_15km$sq, filename="bio14_sd_15km", format="GTiff")

#sq of bio14 21km
window <- matrix(1, nrow = 21 , ncol = 21)
bio14_sd_21km <- focal_metrics(bio14, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/21x")
#writeRaster(bio14_sd_21km$sq, filename="bio14_sd_21km", format="GTiff")

#sq of bio14 27km
window <- matrix(1, nrow = 27 , ncol = 27)
bio14_sd_27km <- focal_metrics(bio14, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/27x")
#writeRaster(bio14_sd_27km$sq, filename="bio14_sd_27km", format="GTiff")

#sq of bio14 33km
window <- matrix(1, nrow = 33 , ncol = 33)
bio14_sd_33km <- focal_metrics(bio14, window, metrics = list('sq'),
                              progress = TRUE)

#setwd("D:/zarnetske_lab/chelsa_sd/33x")
#writeRaster(bio14_sd_33km$sq, filename="bio14_sd_33km", format="GTiff")
```
