---
title: "Can scale-dependant geodiversity improve species distribution models in a
  Neotropical biodiversity hotspot?"
author: "Beth Gerstner"
date: "2023-01-02"
output:
  word_document: default
  html_document:
    df_print: paged
---

Overview: This script obtains the occurrence records for species of interest in Colombia. It extracts records over the BioModelos API. Records are then counted. Certain species could not be downloaded over the API and had to be obtained manually through the BioModelos website. These are then cleaned and merged into the full dataset.

*note currently this API does not seem to be working.

Data output: csv file of occurrence records for all species.

Date: 10/1/22
Modified: 1/1/23


Load packages

```{r, message=FALSE, warning=FALSE}
library(spocc)
library(spThin)
library(dismo)
library(rgeos)
library(ENMeval)
library(wallace)
library(dplyr)                                                
library(plyr)                                                 
library(readr)  
library(data.table)
library(janitor)

```

Read in species list of interest. These are species that have validated models on BioModelos. We use these occurrence records because they have been vetted by experts at BioModelos. Also, we would like to make comparisons with BioModelos models as a way of validating our method of making distribution maps.

```{r}
scientific_names_mammals <- read.csv("C:/Users/bgers/Desktop/final_species_list.csv")
bioKey <- "5NbMdjylEPEN1cBCIsX9dl:3vbVvDAXQdjf40NeYHfN1g"
```

Download occurrence records from BioModelos
```{r, eval=FALSE}
all.mammals.biomod <- data.frame()
for(i in 1:nrow(scientific_names_mammals)){
  species.i <- scientific_names_mammals[i,"species"]
  bioModelos <- occs_biomodelos(
    spN = species.i,
    bioKey = bioKey)
  occs_i <- bioModelos$cleaned
  occs_i <- occs_i[,c("scientific_name","latitude","longitude","year","state_province","record_type", "catalog_number", "institution_code")]
  all.mammals.biomod= rbind(all.mammals.biomod, occs_i)
}
```

Split species list because one species Cheracebus lucifer was causing the loop to throw errors.
```{r, eval=FALSE}
all.mammals.1 <- data.frame()
for(i in 27:32){
  species.i <- scientfic_names_mammals[i,"species"]
  bioModelos <- occs_biomodelos(
    spN = species.i,
    bioKey = bioKey)
  occs_i <- bioModelos$cleaned
  occs_i <- occs_i[,c("scientific_name","latitude","longitude","year","state_province","record_type", "catalog_number", "institution_code")]
  all.mammals.1= rbind(all.mammals, occs_i)
}
```

Join list for species downloaded over API
```{r, eval=FALSE}
all.mammals.full <- rbind(all.mammals, all.mammals.1)
setwd("C:/Users/bgers/Desktop/MSU/Zarnetske_Lab/Data/Chapter_1/candidate_species_dataset")

#write to csv
write.csv(all.mammals.full,path="all_mammals_biomodelos.csv")
```

Count number of records per species
```{r, eval=FALSE}
species_num <- all.mammals %>%
  count(scientific_name, sort = TRUE) 
```

Downloaded certain species individually on the BioModelos website because of errors and pulled them in all together
```{r}
single_data <- list.files(path = "C:/Users/bgers/Desktop/MSU/Zarnetske_Lab/Data/Chapter_1/candidate_species_dataset/biomodelos_singles",    
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read_csv) %>%                                           
  bind_rows                                                      

#Convert to dataframe
single_data <- as.data.frame(single_data)

#Subset columns
single_data_clean <- single_data[,c("species","latitude","longitude","year", "stateProvince","basisOfRecord","catalogNumber",
                                    "institutionCode")]

```

Read in API dataset if haven't run above
*all.mammals <- read.csv("C:/Users/bgers/Desktop/MSU/Zarnetske_Lab/Data/Chapter_1/candidate_species_dataset/all_mammals_biomodelos_2022.csv")*


Rename multiple columns for old to new and bind all data
```{r, eval=FALSE}
setnames(single_data_clean, old = c('species','stateProvince','basisOfRecord','catalogNumber','institutionCode'), 
         new = c('scientific_name','state_province','record_type','catalog_number','institution_code'))
names(single_data_clean)

#bind all biomodelos datasets together
full_biomodelos_data <- rbind(all.mammals,single_data_clean)
write.csv(full_biomodelos_data, "full_biomodelos_data.csv")
```

Count records for each species
```{r, eval=FALSE}
species_num_final <- full_biomodelos_data %>%
  count(scientific_name) 

tabyl(full_biomodelos_data, scientific_name)

```

